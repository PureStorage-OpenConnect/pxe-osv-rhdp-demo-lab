== Scenario - Persistent Storage Volume Provisioning and Availability for Virtual Machines

In this scenario, we will learn about how to provision a virtual machine
on OpenShift Virtualization with Purestorage.

== Step 1 - Deploy a virtual machine using OC

Let's start by building VM using the `oc` command line tool.

=== Task 1: Generate an SSH keypair

In order to interact with our virtual machine, let's create an ssh keypair.

[source,sh,role=execute]
----
ssh-keygen -t rsa -b 4096 -f ~/.ssh/id_rsa -N ""
----

=== Task 2: Create an Openshift Secret with our SSH key:


[source,sh,role=execute]
----
ID_RSA_PUB=$(cat ~/.ssh/id_rsa.pub)
cat << EOF | oc apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: authorized-keys
data:
  key: $(cat ~/.ssh/id_rsa.pub | base64 -w0)
EOF
----

=== Task 3: Create an Openshift Virtual Machine

[source,sh,role=execute]
----
cat << EOF | oc apply -f -
apiVersion: kubevirt.io/v1
kind: VirtualMachine
metadata:
  creationTimestamp: null
  name: centos-stream9-example
spec:
  dataVolumeTemplates:
  - metadata:
      creationTimestamp: null
      name: centos-stream9-example-ds-centos-stream9
    spec:
      sourceRef:
        kind: DataSource
        name: centos-stream9
        namespace: openshift-virtualization-os-images
      storage:
        resources: {}
  instancetype:
    name: u1.medium
  preference:
    name: centos.stream9
  runStrategy: Always
  template:
    metadata:
      creationTimestamp: null
    spec:
      domain:
        devices: {}
        resources: {}
      terminationGracePeriodSeconds: 180
      volumes:
      - dataVolume:
          name: centos-stream9-example-ds-centos-stream9
        name: centos-stream9-example-ds-centos-stream9
      - cloudInitNoCloud: 
          userData: |-
            #cloud-config
            user: cloud-user
        name: cloudinitdisk
      accessCredentials:
        - sshPublicKey:
            propagationMethod:
              noCloud: {}
            source:
              secret:
                secretName: authorized-keys 
EOF
----

The above created a VM called `centos-stream9-example` that we will use for the rest of the labs.

We can log in to this VM 

== Step 2 - Deploy a Virtual Machine using the Openshift Console

Start by logging in to the OpenShift console.

=== Task 1: Create a new VM

Navigate to the virtualzation > overview menu

image:create-vm-01.png[Select VMs]

Click the `Create Virtual Machine` button

image:create-vm-02.png[Click Button]

Select the Centos Stream image. We can also use the default instance
type.

image:create-vm-03-2.png[Select CentOS]

Verify that our StorageClass is set to `px-csi-db` and click
`Create VirtualMachine`

image:create-vm-04.png[Select StorageClass]

This will automatically start the virtual machine after a short
provisioning process.

____
It can take a couple of minutes for our VM to boot the
first time
____

Explore the tabs for this virtual machine. We can view metrics,
configure snapshots, and even view the YAML configuration to make
automating easy.

image:create-vm-06.png[Interact with VM]

____
The Virtual Machine name will be different in your
environment
____

Click `Next` to move on to the next challenge
